<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—É—Ä–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω –î–Ω–µ–ø—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #212121;
            --tg-theme-hint-color: #707579;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #ffffff;
            --color-water: #0088cc;
            --color-earth: #8b4513;
        }
        body { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; padding-bottom: 80px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        h1, h2, h3 { color: var(--color-water); margin-top: 0; }
        h1 { font-size: 1.8rem; line-height: 1.2; margin-bottom: 10px; }
        h2 { font-size: 1.4rem; margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        h3 { font-size: 1.1rem; color: var(--tg-theme-text-color); }
        p { line-height: 1.6; color: var(--tg-theme-text-color); margin-bottom: 12px; }
        .card { background: rgba(0,0,0,0.03); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .card-list { list-style: none; padding: 0; margin: 0; }
        .card-list li { padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .price-tag { font-weight: bold; color: var(--color-earth); }
        .benefits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .benefit-item { text-align: center; padding: 10px; background: #f8fbff; border-radius: 8px; font-size: 0.9rem; font-weight: 500; }
        
        /* Gallery */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .gallery-item { border-radius: 8px; overflow: hidden; background: #eee; position: relative; aspect-ratio: 1/1; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item.video { grid-column: span 2; aspect-ratio: 16/9; }

        /* Process */
        .step { display: flex; gap: 10px; margin-bottom: 12px; }
        .step-num { background: var(--color-water); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; margin-top: 2px; }
        .step-content strong { display: block; margin-bottom: 2px; }

        /* Forms & Buttons */
        .btn-primary { width: 100%; padding: 14px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary:active { opacity: 0.8; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); box-sizing: border-box; font-size: 16px; }
        
        /* Status */
        .status-msg { text-align: center; padding: 10px; margin-top: 10px; border-radius: 8px; font-weight: bold; display: none; }
        .status-success { background: #e6f7ee; color: #1a8b52; display: block; }
        .status-error { background: #fce8e6; color: #d23a35; display: block; }

        /* Navigation */
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--tg-theme-bg-color); border-top: 1px solid var(--tg-theme-hint-color); display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .menu-btn { background: none; border: none; color: var(--tg-theme-hint-color); font-size: 10px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .menu-btn span { font-size: 18px; }
        .menu-btn.active { color: var(--tg-theme-button-color); }
        
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    
    <!-- HOME -->
    <div id="view-home" class="view active">
        <div class="container">
            <div class="card" style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border: none;">
                <h1>üíß –ë—É—Ä–µ–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω –Ω–∞ –≤–æ–¥—É</h1>
                <p>–î–Ω–µ–ø—Ä –∏ –î–Ω–µ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</p>
            </div>
            <h2>–ü–æ—á–µ–º—É –º—ã?</h2>
            <div class="benefits-grid">
                <div class="benefit-item">üöõ<br>–ú–∏–Ω–∏-—Ç–µ—Ö–Ω–∏–∫–∞</div>
                <div class="benefit-item">üõ°Ô∏è<br>–ì–∞—Ä–∞–Ω—Ç–∏—è</div>
                <div class="benefit-item">üíß<br>–ß–∏—Å—Ç–∞—è –≤–æ–¥–∞</div>
                <div class="benefit-item">‚ö°<br>–ó–∞ 1 –¥–µ–Ω—å</div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>–°—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <ul class="card-list">
                    <li><span>–ë—É—Ä–µ–Ω–∏–µ (1–º):</span> <span class="price-tag">500 –≥—Ä–Ω</span></li>
                    <li><span>–¢—Ä—É–±–∞ (1–º):</span> <span class="price-tag">400 –≥—Ä–Ω</span></li>
                    <li><span>–ê–±–∏—Å—Å–∏–Ω—Å–∫–∏–π –∫–æ–ª–æ–¥–µ—Ü:</span> <span class="price-tag">–æ—Ç 3000 –≥—Ä–Ω</span></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- GALLERY -->
    <div id="view-gallery" class="view">
        <div class="container">
            <h2>–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç</h2>
            <div class="card">
                <div class="gallery-grid">
                    <div class="gallery-item video">
                        <video controls poster="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=400&q=80">
                            <source src="https://cdn.coverr.co/videos/coverr-drilling-a-hole-in-the-ground-5594/1080p.mp4" type="video/mp4">
                        </video>
                    </div>
                    <div class="gallery-item"><img src="https://images.unsplash.com/photo-1621112904887-4f5e2813c468?auto=format&fit=crop&w=400&q=80"></div>
                    <div class="gallery-item"><img src="https://images.unsplash.com/photo-1590674899505-1c5c4195c16a?auto=format&fit=crop&w=400&q=80"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SERVICES -->
    <div id="view-services" class="view">
        <div class="container">
            <h2>–û–±—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h2>
            <div class="card">
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-content"><strong>–í—ã–±–æ—Ä –º–µ—Å—Ç–∞</strong>–ê–Ω–∞–ª–∏–∑ —É—á–∞—Å—Ç–∫–∞.</div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-content"><strong>–ë—É—Ä–µ–Ω–∏–µ</strong>–î–æ –≤–æ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ —Å–ª–æ—è.</div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-content"><strong>–û–±—Å–∞–¥–∫–∞</strong>–°—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä—É–±—ã.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBSCRIBE (–°–ö–ò–î–ö–ò) -->
    <div id="view-subscribe" class="view">
        <div class="container">
            <h2>–°–∫–∏–¥–∫–∏ –∏ —Ä–∞—Å—Å—ã–ª–∫–∞</h2>
            <div class="card">
                <h3>–£–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∏–¥–∫–∏</h3>
                
                <label style="font-size: 12px; color: var(--tg-theme-hint-color);">–í–∞—à —Ä–∞–π–æ–Ω –±—É—Ä–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <select id="sub-region">
                    <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>

                <input type="text" id="sub-comment" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –≤–æ–ø—Ä–æ—Å">
                
                <div id="sub-status" class="status-msg"></div>
                <button class="btn-primary" id="btn-sub">–ü–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
                
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∞–π–æ–Ω–µ. 
                </div>
            </div>
        </div>
    </div>

    <!-- ABOUT -->
    <div id="view-about" class="view">
        <div class="container">
            <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <div class="card">
                <p><strong>–¢–µ–ª–µ–≥—Ä–∞–º:</strong> @drill_dnepr_bot</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +38 (050) 123-45-67</p>
                <div style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--tg-theme-hint-color);">
                    <a href="/admin" style="color: inherit; text-decoration: none;">–í–æ–π—Ç–∏ –∫–∞–∫ Admin</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-menu">
        <button class="menu-btn" data-target="view-gallery"><span>üì∏</span>–§–æ—Ç–æ</button>
        <button class="menu-btn" data-target="view-services"><span>üõ†Ô∏è</span>–£—Å–ª—É–≥–∏</button>
        <button class="menu-btn active" data-target="view-home" style="order: -1; transform: scale(1.2); color: var(--tg-theme-text-color);"><span>üè†</span></button>
        <button class="menu-btn" data-target="view-subscribe"><span>üìû</span>–°–ö–ò–î–ö–ò</button>
        <button class="menu-btn" data-target="view-about"><span>üìç</span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        const user = tg ? tg.initDataUnsafe.user : null;

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ ---
        async function loadRegions() {
            try {
                const response = await fetch('/api/get_regions');
                const regions = await response.json();
                const select = document.getElementById('sub-region');
                select.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω</option>';
                regions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = r.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤", e);
            }
        }

        // Navigation
        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(btn.dataset.target).classList.add('active');
                if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            });
        });

        // Subscription Logic
        document.getElementById('btn-sub').addEventListener('click', async () => {
            const comment = document.getElementById('sub-comment').value;
            const regionId = document.getElementById('sub-region').value;

            if (!regionId) { 
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω –±—É—Ä–µ–Ω–∏—è'); 
                return; 
            }
            if (!comment.trim()) { alert('–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É'); return; }

            const statusDiv = document.getElementById('sub-status');
            const btn = document.getElementById('btn-sub');
            btn.disabled = true; btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            statusDiv.style.display = 'none';

            try {
                const response = await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_id: user ? user.id : 999999999, 
                        first_name: user ? user.first_name : 'Test', 
                        username: user ? user.username : 'test', 
                        comment: comment,
                        region_id: regionId // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    statusDiv.className = 'status-msg status-success';
                    statusDiv.innerText = "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ —Å–∫–∏–¥–æ—á–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.";
                    statusDiv.style.display = 'block';
                    document.getElementById('sub-comment').value = "";
                    document.getElementById('sub-region').selectedIndex = 0;
                    if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } else { 
                    throw new Error(result.message || 'Error'); 
                }
            } catch (e) {
                statusDiv.className = 'status-msg status-error';
                statusDiv.innerText = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏";
                statusDiv.style.display = 'block';
                console.error(e);
                if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            } finally {
                btn.disabled = false; btn.innerText = "–ü–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É";
            }
        });

        // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadRegions);
        } else {
            loadRegions();
        }
    </script>
</body>
</html>